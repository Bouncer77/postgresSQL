# Динамические команды

Внутри pg/plsql блока можно сформировать и выполнить каманду SQL 

## Зачем

1. Дополнительная гибкость при работе приложения
	
	При наступление событий может выполняться определенные команды
	Настройка приложения на этапе эксплуатации, самим пользователем

2. В зависимости от комбинации параметров будет разный текст запросов - лишние соединения 

	Формируем динамически текст запроса от переданных параметров.
	Лучше чем один универсальный запрос.

* Нельзя использовать подготовленные операторы. 
* Риск внедрения SQL кода - информационная безопасность
* Сложность отладки
* Сложность сопровождения - например найти все места в которых есть обращение к таблице - в динамическом SQL название таблицы может формироваться динамически в строке - расплата за гибкость

EXECUTE строка-команды-sql 
[INTO [STRICT] цель] -- переменную или набор переменных, STRICT - гарантия того что вернется одна строка
[USING выражение [, ...]]; -- перечисляем выражение, которые должны подставиться конкретные выражения -- DNL: INSERT, UPDATE, DELETE, SELECT 

### Проверка результата выполнения 

GET DIAGNISTICS, FOUND

### Формирование текста динамической команды

Передавать параметры через конструкцию USING

Подставлять имена объектов столбцов и таблиц - функция формат 
format('%I')  -- %I правильно подставляет название объекта в текст команды (I - Identificator) - аналогичная функция quote_ident()

format('%L') -- литералы - аналогичные функции quote_literal(), quote_nullable()

экранирование строк: $$ ... $$

### Синтаксис 

FOR цель IN EXICUTE строка-команды-sql [USING выражение [, ...]]
LOOP
	тело-цикла
END LOOP;

OPEN курсорная-переменная -- refcursor и не должна быть связана с запросом
	FOR EXECUTE строка-команды [USING выражение [, ...]]
...
CLOSE курсорная-переменная

Вернуть динамически количество строк - произвольная выборка

RETURN QUERY EXECUTE строка-команды
	[USING выражение [, ...]]; 

## Примеры

```sql
DO $$
DECLARE
	cmd text := 'CREATE TABLE city_msk (id serial, qty int, d date)';
BEGIN
	EXECUTE cmd; -- Таблица для Москвы

	cmd := replace(cmd, 'city_msk', 'city_brn');
	EXECUTE cmd; -- таблица для Барнаула
END;
$$;

-- Возврат одной строки
DO $$
DECLARE
	cmd text := 'INSERT INTO city_msk (qty, d)
				 VALUES (round(random() * 100), current_date)
				 RETURNING id, qty, d';
	rec record;
BEGIN
	EXECUTE cmd INTO rec;
	RAISE NOTICE 'id : %, qty: %, d: %', rec.id, rec.qty, rec.d;
END;
$$;
```

