<!-- MarkdownTOC autolink="true" -->

- [Команды](#%D0%9A%D0%BE%D0%BC%D0%B0%D0%BD%D0%B4%D1%8B)
	- [Получить справку по командам](#%D0%9F%D0%BE%D0%BB%D1%83%D1%87%D0%B8%D1%82%D1%8C-%D1%81%D0%BF%D1%80%D0%B0%D0%B2%D0%BA%D1%83-%D0%BF%D0%BE-%D0%BA%D0%BE%D0%BC%D0%B0%D0%BD%D0%B4%D0%B0%D0%BC)
	- [Основные команды](#%D0%9E%D1%81%D0%BD%D0%BE%D0%B2%D0%BD%D1%8B%D0%B5-%D0%BA%D0%BE%D0%BC%D0%B0%D0%BD%D0%B4%D1%8B)
	- [Вариант взаимодействия](#%D0%92%D0%B0%D1%80%D0%B8%D0%B0%D0%BD%D1%82-%D0%B2%D0%B7%D0%B0%D0%B8%D0%BC%D0%BE%D0%B4%D0%B5%D0%B9%D1%81%D1%82%D0%B2%D0%B8%D1%8F)
	- [Настройки](#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B8)
	- [Выводить кирилицу](#%D0%92%D1%8B%D0%B2%D0%BE%D0%B4%D0%B8%D1%82%D1%8C-%D0%BA%D0%B8%D1%80%D0%B8%D0%BB%D0%B8%D1%86%D1%83)
	- [Терминальный пейджер](#%D0%A2%D0%B5%D1%80%D0%BC%D0%B8%D0%BD%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B9-%D0%BF%D0%B5%D0%B9%D0%B4%D0%B6%D0%B5%D1%80)
	- [Форматирование вывода pset](#%D0%A4%D0%BE%D1%80%D0%BC%D0%B0%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D0%B2%D1%8B%D0%B2%D0%BE%D0%B4%D0%B0-pset)
		- [Взаимодействие с ОС и выполнение скриптов](#%D0%92%D0%B7%D0%B0%D0%B8%D0%BC%D0%BE%D0%B4%D0%B5%D0%B9%D1%81%D1%82%D0%B2%D0%B8%D0%B5-%D1%81-%D0%9E%D0%A1-%D0%B8-%D0%B2%D1%8B%D0%BF%D0%BE%D0%BB%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5-%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82%D0%BE%D0%B2)
		- [Переменные psql](#%D0%9F%D0%B5%D1%80%D0%B5%D0%BC%D0%B5%D0%BD%D0%BD%D1%8B%D0%B5-psql)
	- [copy](#copy)

<!-- /MarkdownTOC -->

# Команды

## Получить справку по командам

В терминале:
1. $ psql --help
2. $ man psql

В psql:

Команда | Описание
--------|-----------------------------------------
\?      | список команд psql
\? variables | переменные psql
\h[elp] | список команд SQL
\h команда | синтаксис команды SQL

## Основные команды

Команда | Описание
--------|-----------------------------------------
\с[onnection] <имя_бд> | подключение к базе данных
\conninfo | Информация о текущем подключение: база данных, имя пользователя, сокет, порт
\x      | Переключает традиционный табличный вывод (столбцы и строки) на 		расширенный (каждый столбец на отдельной строке) и обратно. Удобно для просмотра нескольких «широких» строк
\l      | Список баз данных
\du     | Список пользователей
\d [имя_объекта]  | информация по конкретному объекту базы данных (таблица, последовательностьб)
\d+ [имя_объекта] | подробная информация по конкретному объекту (таблица, последовательность)
\dt [имя_таблицы] | Список таблиц
\di     | Список индексов
\dv     | Список представлений
\df     | Список функций
\dn     | Список схем
\dx     | Список установленных расширений
\dp     | Список привилегий
\timing | on Показывать время выполнения операторов
\d      | завершить сеанс
\!      | Выход в шел без прерывания сессии работы с базой данных
\e      | Редактирование запросов во внешнем редакторе (export PSQL_EDITOR="vim")
\ef <procedure name>       | Редактирование хранимой процедуры
\copy   | импортировать целые таблицы или результаты запросов в файлы и экспортировать данных из файлов в таблицы
\! chcp 1251 | сменить кодировку консоли
\conninfo    | Вывести информацию о соединение
\i 'C:\\Projects\\notes\\Postgres\\test_db\\create.sql' | Выполнить скрипт 
\q или \exit или \quit | выход из psql


## Вариант взаимодействия

Команда                                | Значение
---------------------------------------|--------------------------
psql -h localhost -p 5432 -U postgres  | Подключиться к бд
\! chcp 1251                           | Сменить кодировку консоли из Shell
\x                                     | Каждый столбец на отдельной строке
\gx                                    | Тоже самое что и \x только вводится вместо ';' в конце оператора
\l                                     | Список баз данных
\c <имя_базы данных>                   | Пдключиться к базе данных
\conninfo                              | Вывести информацию о соединение
\d                                     | Список таблиц (отношений)
\i <путь_до_скрипта>                   | Выполнить SQL скрипт из файла
\q                                     | Выход

Пример пути: 


\i 'C:\\Projects\\notes\\Postgres\\test_db\\create.sql'

Из текущей директории
\i <имя_файла>

! Файл должен быть в кодировке 1251 и с расширением sql

## Настройки

* postgresql.conf — это основной конфигурационный файл, содержащий значения параметров сервера;

* pg_hba.conf — файл, определяющий настройки доступа. В целях безопасности по умолчанию доступ долже быть подтвержден паролем и допускается только с локального компьютера.

## Выводить кирилицу

Из psql можно выполнять команды shell:

\! chcp 1251 | сменить кодировку консоли

## Терминальный пейджер

Терминальный пейджер more:
Q - выход
Enter - следующая строка
Пробел - на страницу вперед

Перейти с more на less
export PAGER="less"
export LESS="-iMSx4 -FX"
Помимо всего вышеперечисленного опция S отключает перенос длинных строк, что улучшает читабельность результата запроса.

## Форматирование вывода pset

### Взаимодействие с ОС и выполнение скриптов

Все возможности форматирования результатов запросов доступны через команду \pset.

\a — переключатель режима: с выравниванием/без выравнивания.

\t — переключатель отображения строки заголовка и итоговой строки.

С помощью запроса SQL можно сформировать несколько других запросов SQL и записать их в файл, используя команду \o[ut]:

=> \pset fieldsep ''
Field separator is "".
=> \o dev1_psql.log

Вернем вывод на экран и восстановим форматирование по умолчанию.
=> \o \t \a

Выполним теперь эти команды из файла с помощью \i[nclude]:

```sql
\a \t
\pset fieldsep ''
\o dev1_psql.log

SELECT format('SELECT %L AS tbl, count(*) FROM %I;', tablename, tablename)
FROM pg_tables
LIMIT 3;

\! cat dev1_psql.log
\o \t \a
\i dev1_psql.log

--- Впрочем, то же самое можно получить за один шаг, используя команду \gexec
SELECT format('SELECT %L AS tbl, count(*) FROM %I;', tablename, tablename)
FROM pg_tables LIMIT 3 \gexec
```

\gexec
Для выполнения SQL команд, который были сгенерированы SQL командой
https://dbtut.com/index.php/2019/02/03/postgresql-psql-gexec/

Другие способы выполнить команды из файла:
psql < имя_файла
psql -f имя_файла
psql -c 'команда' (работает только для одной команды)

### Переменные psql

Присвоение значения переменной top5 лучше записать в стартовый файл .psqlrc в домашнем каталоге пользователя. Команды из .psqlrc будут
автоматически выполняться каждый раз при старте psql.

Команды из файла рассположенного в директории 

Получить дирректорию для файла .psqlrc:
1. $ pg_config --sysconfdir
вывести путь до места поиска файла с настройками ("C:\Apps\PostgresSQL\etc")

2. Создать там директорию etc

3. Поместить туда файл с именем "psql"  ( подробнее: C:\Apps\PostgresSQL\share\psqlrc.sample)

4.  Добавить туда строчки:
\set PROMPT1 '%M:%> %n@%/%R%#%x '
! chcp 1251

Первая строчка в пункте 4 форматирует переменную PROMPT1, которая задает приглашение для пользователя
Пример:
localhost:5432 postgres@db_insurance_ref=#

\set TEST Hi!
\echo :TEST // Hi! 
\unset TEST
\echo :TEST // :TEST

## copy

Сохраняю содержимое таблицы в файл customers.dump:
db1# \copy customers to 'customers.dump'
Загружаю содержимое файла в другую таблицу:
db2# \copy temp_customers from 'customers.dump'
P.s. Важно, чтобы таблицы, которые участвуют в переносе, имели одинаковую структуру

